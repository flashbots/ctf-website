<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flashbots</title>
    <link rel="stylesheet" href="styles-leaderboard.css">
    
  </head>

  <body>
    <header>
      <div class="logo"><a style='color: inherit; font-style: inherit;' href="/">MEV-Share CTF</a></div>

      <nav>
        <!-- temporary hard-coded grey-out & selection styles serve as placeholders for unfinished work -->
        <div class="disabled">CHALLENGES</div>
        <div class="selectedNav">LEADERBOARD</div>
        <div class="disabled">ACTIVITY</div>
      </nav>

      <div class="connected">Â· Connected</div>
    </header>

    <div class="content">
      <table class="leaderboard">
        <thead>
          <th class="leaderboard">PLACE</th>
          <th class="leaderboard">ADDRESS</th>
          <th class="leaderboard">PROGRESS</th>
          <th class="leaderboard">FLAGS CAPTURED</th>
          <th class="leaderboard">SCORE</th>
        </thead>
        <tbody class="leaderboard">
        </tbody>
      </table>
    </div>

    <footer>
      <div>Date</div>
      <div>Time</div>
    </footer>

    <script>
      const TOTAL_CHALLENGES = 9
      document.addEventListener("DOMContentLoaded", onPageLoad)

      /* ================= HELPERS ========================================== */
      const placeSuffix = (place) => {
        return place === 0 ? "th" :
        place === 1 ? "st" :
        place === 2 ? "nd" :
        place === 3 ? "rd" :
        // those pesky teens really complicate things
        (place >= 4 && place < 20) ? "th" : place > 100 ? placeSuffix(place % 100) : placeSuffix(place % 10)
      }

      const placeWithSuffix = (place) => {
        return `${place}${placeSuffix(place)}`
      }

      const colorPalette = {
        red: "#ff2d2d",
        yellow: "#ffb546",
        green: "#37ffb7",
        purple: "#b266ff"
      }

      /* ================= COMPONENTS ======================================= */
      const simWins = (numWins) => {
        const simWin = {points: 2, captureId: 201, blockNumber: 9446648}
        const wins = [...Array(numWins).keys()].map(idx => simWin)
        return {
          timeline: wins,
          totalPoints: wins.map(w => w.points).reduce((a, b) => a + b)
        }
      }

      function scoreRow(place, scoreCard) {
        const specialClass = (place === 1) ? "rainbow" : ""
        return `<tr class="leaderboard-row ${specialClass}">
          <td class="leaderboard"><code>${placeWithSuffix(place)}</code></td>
          <td class="leaderboard"><code>${scoreCard.address}</code></td>
          <td class="leaderboard">${progressBar(scoreCard.flagsCaptured)}
          <td class="leaderboard"><code>${scoreCard.flagsCaptured}</code></td>
          <td class="leaderboard"><code>${scoreCard.totalPoints}</code></td>
        </tr>`
      }

      function scoreboardRows(scores) {
        let scoreMap = Object.entries(scores)
        .map(([address, scoreData]) => {
          return {
            address,
            totalPoints: scoreData.totalPoints,
            flagsCaptured: scoreData.timeline.length,
          }
        })
        .sort((a, b) => b.totalPoints - a.totalPoints)
        return scoreMap.map((scoreCard, idx) => scoreRow(idx + 1, scoreCard)).reduce((prv, cur) => prv + cur)
      }

      function progressBar(challengesComplete) {
        const totalProgressPercent = (challengesComplete / TOTAL_CHALLENGES) * 100
        console.log("totalProgress", totalProgressPercent)
        const bandSize = 100 / TOTAL_CHALLENGES
        console.log("bandSize", bandSize)
        const color = (idx) => {
          const thisPercent = (idx + 1) * bandSize
          console.log("thisPercent", thisPercent)
          const thisBandColor = thisPercent < 33 ? colorPalette.purple : thisPercent < 66 ? colorPalette.green : thisPercent <= 90 ? colorPalette.yellow : colorPalette.red
          return totalProgressPercent >= thisPercent ? thisBandColor : "black"
        }
        const progressNugget = (idx) => `<div class="progress-nugget" style="background-color: ${color(idx)};"></div>`
        // set color up to progress point, then use no color for the remaining nuggets
        const nuggets = [...Array(TOTAL_CHALLENGES).keys()].map(idx => idx < challengesComplete ? progressNugget(idx) : progressNugget("black")).reduce((a,b) => a+b)
        return `<div class="progress-container">${nuggets}</div>`
      }
      
      /* ================= INIT ============================================= */
      function onPageLoad() {
        // load participants
        async function loadScores() {
          const scoreboard = await fetch("https://ctf-data.flashbots.net/events.json")
          let res = await scoreboard.json()
          return {
            ...res
          }
        }

        loadScores().then((scores) => {
          console.log("scoreboard", scores)
          let tbody = document.querySelector("tbody.leaderboard")
          tbody.innerHTML = scoreboardRows(scores)
        })
      }
    </script>
  </body>
</html>